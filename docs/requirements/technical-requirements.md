# 技術要件

## 概要

Auto Chat Makerシステムの技術要件を定義します。Teamsチャット対応を基本とし、将来的なOutlookメール対応も考慮した拡張性のある技術構成を採用します。

## 技術構成

### フロントエンド
| 技術 | 詳細 | 役割 |
|------|------|------|
| **UIフレームワーク** | React/Vue.js | 返信案選択・編集UI |
| **状態管理** | Redux/Vuex | アプリケーション状態管理 |
| **UIライブラリ** | Material-UI/Vuetify | モダンなUIコンポーネント |

### バックエンド
| 技術 | 詳細 | 役割 |
|------|------|------|
| **言語** | Python 3.8以上 | メイン開発言語 |
| **Webフレームワーク** | FastAPI | RESTful API提供 |
| **ORM** | SQLAlchemy | データベース操作 |
| **非同期処理** | Celery + Redis | バックグラウンド処理 |

### MCP通信
| 技術 | 詳細 | 役割 |
|------|------|------|
| **MCPサーバー** | `ms-365-mcp-server` | Teamsチャット連携 |
| **通信プロトコル** | HTTP/HTTPS | MCPサーバーとの通信 |
| **認証** | OAuth2 | Microsoft 365認証 |

### 外部API連携
| 技術 | 詳細 | 役割 |
|------|------|------|
| **Microsoft Graph API** | Microsoft Graph API | Teamsチャット・スレッド・サブスクリプション管理 |
| **AIサービス** | Claude API（Anthropic） | 返信判断・案生成 |

### データベース
| 技術 | 詳細 | 役割 |
|------|------|------|
| **RDBMS** | PostgreSQL | メインデータベース |
| **キャッシュ** | Redis | セッション・キャッシュ管理 |
| **マイグレーション** | Alembic | データベーススキーマ管理 |

### 開発・運用ツール
| 技術 | 詳細 | 役割 |
|------|------|------|
| **コード品質** | Black, isort, flake8, mypy | コードフォーマット・静的解析 |
| **テスト** | pytest | ユニット・統合テスト |
| **CI/CD** | GitHub Actions | 自動テスト・デプロイ |
| **コンテナ** | Docker | 環境統一・デプロイ |

## 拡張性設計

### プラグインアーキテクチャ

#### メッセージ処理プラグイン
- **共通インターフェース**: メッセージ処理の抽象化
- **Teamsチャットプラグイン**: 現在対応
- **Outlookメールプラグイン**: 将来対応予定
- **プラグイン管理**: 動的なプラグイン登録・管理

#### 設定管理
- **機能フラグ**: 各機能の有効/無効切り替え
- **プラグイン設定**: プラグイン固有の設定管理
- **環境別設定**: 開発・ステージング・本番環境の設定分離

### データベース設計の拡張性

#### メッセージタイプ対応
- **共通テーブル**: メッセージの基本情報
- **プラグイン固有テーブル**: 各プラグインの拡張情報
- **メッセージタイプ管理**: 動的なメッセージタイプ追加

#### スキーマ設計
```sql
-- メッセージタイプ管理テーブル
CREATE TABLE message_types (
    id UUID PRIMARY KEY,
    type_name VARCHAR(50) UNIQUE NOT NULL,
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 共通メッセージテーブル
CREATE TABLE messages (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES users(id),
    message_id VARCHAR(255) UNIQUE NOT NULL,
    message_type_id UUID REFERENCES message_types(id),
    content TEXT,
    sender VARCHAR(255),
    sent_at TIMESTAMP,
    processed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## セキュリティ要件

### 認証・認可
- **Microsoft 365認証**: OAuth2認証フロー
- **JWTトークン**: セッション管理
- **ロールベースアクセス制御**: ユーザー権限管理

### データ保護
- **通信暗号化**: TLS 1.3以上
- **データベース暗号化**: 保存時暗号化
- **機密情報マスキング**: ログ出力時の個人情報保護

### Webhookセキュリティ
- **HMAC署名検証**: Webhookリクエストの検証
- **IP制限**: 許可されたIPからのリクエストのみ受信
- **レート制限**: API呼び出し回数の制限

## パフォーマンス要件

### 処理時間
- **チャットメッセージ処理**: 10秒以内
- **AI判定・生成**: 30秒以内
- **返信送信**: 5秒以内
- **UI応答**: 3秒以内

### スループット
- **同時ユーザー数**: 100人以上
- **1日あたりの処理件数**: 10,000件以上
- **データベース接続数**: 20接続以上

### 可用性
- **システム稼働率**: 99.9%以上
- **障害復旧時間**: 30分以内
- **メンテナンス時間**: 月1回、2時間以内

## 監視・ログ

### ログ出力
- **アプリケーションログ**: structlogによる構造化ログ
- **アクセスログ**: FastAPI標準のアクセスログ
- **エラーログ**: エラー詳細とスタックトレース

### メトリクス
- **API応答時間**: 各エンドポイントの応答時間
- **エラー率**: エラー発生率の監視
- **処理件数**: 1日あたりの処理件数
- **外部API呼び出し**: 外部サービスへの呼び出し回数

### アラート
- **システム障害**: 重要なエラーの即座通知
- **パフォーマンス低下**: 応答時間の閾値超過通知
- **外部サービス障害**: 外部API接続失敗通知

## 更新履歴

- 初版作成: 2024年12月
- Teams対応化: 2024年12月 - Teamsチャットベースに変更、拡張性設計を追加
- 最終更新: 2024年12月
- 更新者: 開発チーム
