# 開発計画書

## 概要

Auto Chat Makerシステムの開発計画を定義します。ローカルでの試行を前提とし、段階的な機能実装による効率的な開発を目指します。

## 開発方針

### 基本方針
- **ローカル試行優先**: ローカル環境での動作確認を最優先
- **段階的実装**: 機能を段階的に実装し、各段階で動作確認
- **軽量構成**: 最小限の技術スタックで高速開発
- **拡張性考慮**: 将来的な本番環境移行を考慮した設計

### 技術スタック
- **バックエンド**: FastAPI + SQLite + SQLAlchemy
- **フロントエンド**: FastAPI + HTML/JavaScript
- **非同期処理**: FastAPI非同期機能
- **キャッシュ**: functools.lru_cache
- **ログ**: structlog

## 開発フェーズ

### Phase 1: 基盤構築（1-2週間）

#### 目標
- FastAPIアプリケーションの基本構造構築
- 設定管理・ログ出力機能の実装
- MCPサーバー連携の基本実装

#### 実装内容
1. **FastAPIアプリケーションの基本構造**
   - プロジェクト構造の整理
   - 基本的なルーティング設定
   - エラーハンドリングの実装

2. **設定管理機能**
   - 環境変数による設定管理
   - 設定クラスの実装
   - 設定値のバリデーション

3. **ログ出力機能**
   - structlogによる構造化ログ
   - ログレベルの設定
   - ログファイル出力

4. **MCPサーバー連携の基本実装**
   - MCPサーバーとの接続確認
   - 基本的なAPI呼び出しテスト
   - エラーハンドリング

#### 成果物
- 基本的なFastAPIアプリケーション
- 設定管理システム
- ログ出力システム
- MCPサーバー連携の基本機能

### Phase 2: コア機能実装（2-3週間）

#### 目標
- Claude API連携の実装
- 返信要否判断・返信案生成ロジックの実装
- Webhook受信処理の実装

#### 実装内容
1. **Claude API連携**
   - Claude APIクライアントの実装
   - API認証の実装
   - エラーハンドリング

2. **返信要否判断ロジック**
   - プロンプト設計
   - AI判定ロジックの実装
   - 判定結果の処理

3. **返信案生成ロジック**
   - 返信案生成プロンプトの設計
   - 複数案生成ロジックの実装
   - 生成結果の品質管理

4. **Webhook受信処理**
   - Microsoft Graph Webhook受信エンドポイント
   - Webhook検証ロジック
   - メッセージ処理の統合

#### 成果物
- Claude API連携機能
- 返信要否判断機能
- 返信案生成機能
- Webhook受信処理機能

### Phase 3: データ管理・UI（1-2週間）

#### 目標
- SQLiteデータベースの実装
- シンプルなWeb UIの実装
- 返信案選択・送信機能の実装

#### 実装内容
1. **SQLiteデータベース実装**
   - データベーススキーマ設計
   - SQLAlchemyモデルの実装
   - 基本的なCRUD操作

2. **シンプルなWeb UI**
   - FastAPIテンプレート機能の活用
   - 返信案表示UI
   - 返信案選択機能

3. **返信案選択・送信機能**
   - 返信案選択ロジック
   - MCP経由での返信送信
   - 送信結果の確認

#### 成果物
- SQLiteデータベース
- Web UI
- 返信案選択・送信機能

### Phase 4: 統合・テスト（1週間）

#### 目標
- エンドツーエンドの動作確認
- エラーハンドリングの改善
- ドキュメントの整備

#### 実装内容
1. **エンドツーエンドテスト**
   - 全機能の統合テスト
   - エラーケースのテスト
   - パフォーマンステスト

2. **エラーハンドリング改善**
   - エラー処理の強化
   - ユーザーフレンドリーなエラーメッセージ
   - ログ出力の改善

3. **ドキュメント整備**
   - API仕様書の更新
   - ユーザーマニュアルの作成
   - 開発者ガイドの整備

#### 成果物
- 統合テスト結果
- 改善されたエラーハンドリング
- 整備されたドキュメント

## 実装順序の詳細

### 第1段階: 基盤構築（1-2週間）

#### Week 1: プロジェクト基盤
```
Day 1-2: プロジェクト構造の整理
- src/auto_chat_maker/以下のディレクトリ構造確認
- 基本的な__init__.pyファイルの作成
- 設定管理クラスの実装

Day 3-4: FastAPIアプリケーションの基本実装
- main.pyの実装
- 基本的なルーティング設定
- エラーハンドリングの実装

Day 5: ログ出力機能の実装
- structlogの設定
- ログレベルの設定
- ログファイル出力の設定
```

#### Week 2: 外部連携基盤
```
Day 1-2: MCPサーバー連携の調査・実装
- MCPサーバーの起動・接続確認
- 基本的なAPI呼び出しテスト
- エラーハンドリングの実装

Day 3-4: 設定管理の詳細実装
- 環境変数の設定
- 設定値のバリデーション
- 設定クラスのテスト

Day 5: 基盤機能の統合テスト
- 全基盤機能の動作確認
- エラーケースのテスト
- ドキュメントの更新
```

### 第2段階: コア機能実装（2-3週間）

#### Week 3: AI機能実装
```
Day 1-2: Claude API連携の実装
- Claude APIクライアントの実装
- API認証の実装
- 基本的なAPI呼び出しテスト

Day 3-4: 返信要否判断ロジックの実装
- プロンプト設計
- AI判定ロジックの実装
- 判定結果の処理

Day 5: 返信案生成ロジックの実装
- 返信案生成プロンプトの設計
- 複数案生成ロジックの実装
- 生成結果の品質管理
```

#### Week 4: Webhook処理実装
```
Day 1-2: Microsoft Graph Webhook受信エンドポイント
- Webhook受信エンドポイントの実装
- Webhook検証ロジックの実装
- 基本的なメッセージ処理

Day 3-4: メッセージ処理の統合
- AI機能との統合
- エラーハンドリングの強化
- ログ出力の改善

Day 5: Webhook処理のテスト
- 全機能の統合テスト
- エラーケースのテスト
- パフォーマンステスト
```

#### Week 5: 機能改善・最適化
```
Day 1-2: AI機能の改善
- プロンプトの最適化
- 生成品質の向上
- エラーハンドリングの改善

Day 3-4: Webhook処理の改善
- 処理速度の最適化
- エラー処理の強化
- ログ出力の改善

Day 5: 全機能の統合テスト
- エンドツーエンドテスト
- パフォーマンステスト
- ドキュメントの更新
```

### 第3段階: データ管理・UI（1-2週間）

#### Week 6: データベース実装
```
Day 1-2: SQLiteデータベース設計
- データベーススキーマ設計
- SQLAlchemyモデルの実装
- 基本的なCRUD操作

Day 3-4: データ管理機能の実装
- メッセージ履歴の管理
- 返信案履歴の管理
- データベースマイグレーション

Day 5: データベース機能のテスト
- CRUD操作のテスト
- データ整合性のテスト
- パフォーマンステスト
```

#### Week 7: Web UI実装
```
Day 1-2: シンプルなWeb UI実装
- FastAPIテンプレート機能の活用
- 基本的なHTML/CSS実装
- 返信案表示UI

Day 3-4: 返信案選択・送信機能
- 返信案選択ロジック
- MCP経由での返信送信
- 送信結果の確認

Day 5: Web UIのテスト
- UI機能のテスト
- ユーザビリティテスト
- エラーケースのテスト
```

### 第4段階: 統合・テスト（1週間）

#### Week 8: 最終統合・テスト
```
Day 1-2: エンドツーエンドテスト
- 全機能の統合テスト
- エラーケースのテスト
- パフォーマンステスト

Day 3-4: エラーハンドリング改善
- エラー処理の強化
- ユーザーフレンドリーなエラーメッセージ
- ログ出力の改善

Day 5: ドキュメント整備
- API仕様書の更新
- ユーザーマニュアルの作成
- 開発者ガイドの整備
```

## リスク管理

### 技術的リスク
- **MCPサーバー連携**: 外部依存のため、代替手段の検討が必要
- **Claude API制限**: API制限に達した場合の対応策を準備
- **Webhook設定**: Microsoft Graph Webhookの設定が複雑な場合の対応

### 対応策
- **段階的実装**: 各機能を独立して実装し、依存関係を最小化
- **代替手段の準備**: 外部サービスが利用できない場合の代替手段を検討
- **十分なテスト**: 各段階で十分なテストを実施し、問題を早期発見

## 成功指標

### 技術的指標
- **機能完成度**: 全計画機能の100%実装
- **テストカバレッジ**: 80%以上のテストカバレッジ
- **パフォーマンス**: 各処理時間の目標達成

### 品質指標
- **エラー率**: 1%以下のエラー率
- **レスポンス時間**: 各機能の目標レスポンス時間達成
- **ユーザビリティ**: 直感的な操作が可能

## 更新履歴

- 初版作成: 2024年12月
- ローカル試行版対応: 2024年12月 - 開発計画をローカル試行に最適化
- 最終更新: 2024年12月
- 更新者: 開発チーム
