<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Auto Chat Maker CMS</title>
  <!-- Netlify Identity Widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <!-- DeCap CMS -->
  <script src="https://cdn.jsdelivr.net/npm/decap-cms@3.8.4/dist/decap-cms.js"></script>
</head>
<body>
  <!-- Netlify Identity Widget -->
  <div id="netlify-identity-widget"></div>

  <div id="nc-root">
    <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
      <h2>Auto Chat Maker CMS</h2>
      <p>CMSを読み込み中...</p>
    </div>
  </div>

  <script>
    console.log('=== CMS Debug Information ===');
    console.log('Script loading started');

    // Netlify Identityの初期化
    if (window.netlifyIdentity) {
      console.log('Netlify Identity found, initializing...');
      window.netlifyIdentity.init();
    } else {
      console.error('Netlify Identity not found!');
    }

    // CMS初期化関数
    function initializeCMS() {
      console.log('=== CMS Initialization Attempt ===');

      // デバッグ情報を出力
      console.log('window.CMS:', typeof window.CMS);
      console.log('window.decapCMS:', typeof window.decapCMS);
      console.log('window.netlifyCMS:', typeof window.netlifyCMS);
      console.log('All window properties containing "cms":', Object.keys(window).filter(key => key.toLowerCase().includes('cms')));
      console.log('All window properties containing "decap":', Object.keys(window).filter(key => key.toLowerCase().includes('decap')));

      // 複数のCMSオブジェクト名をチェック
      let cmsObject = null;
      if (window.CMS) {
        cmsObject = window.CMS;
        console.log('Found window.CMS');
      } else if (window.decapCMS) {
        cmsObject = window.decapCMS;
        console.log('Found window.decapCMS');
      } else if (window.netlifyCMS) {
        cmsObject = window.netlifyCMS;
        console.log('Found window.netlifyCMS');
      } else {
        // グローバルオブジェクトからCMSを探す
        const globalObjects = Object.keys(window);
        const cmsKeys = globalObjects.filter(key =>
          key.toLowerCase().includes('cms') ||
          key.toLowerCase().includes('decap')
        );
        console.log('Available CMS-related objects:', cmsKeys);

        // 最初に見つかったCMSオブジェクトを使用
        for (const key of cmsKeys) {
          if (window[key] && typeof window[key] === 'object') {
            cmsObject = window[key];
            console.log('Using CMS object from:', key);
            break;
          }
        }
      }

      if (cmsObject) {
        console.log('CMS object found, calling init()...');
        try {
          if (typeof cmsObject.init === 'function') {
            cmsObject.init();
            console.log('CMS.init() called successfully');
          } else {
            console.error('CMS object found but init() method not available');
            console.log('Available methods:', Object.keys(cmsObject));
          }
        } catch (error) {
          console.error('CMS.init() failed:', error);
        }
      } else {
        console.error('No CMS object available');
        return false;
      }
      return true;
    }

    // 複数のタイミングでCMS初期化を試行
    let initAttempts = 0;
    const maxAttempts = 10;

    function tryInitializeCMS() {
      initAttempts++;
      console.log(`CMS initialization attempt ${initAttempts}/${maxAttempts}`);

      if (initializeCMS()) {
        console.log('CMS initialized successfully');
        return;
      }

      if (initAttempts < maxAttempts) {
        setTimeout(tryInitializeCMS, 500);
      } else {
        console.error('Failed to initialize CMS after maximum attempts');
      }
    }

    // DOMが完全に読み込まれた後に実行
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM Content Loaded');
      // 少し遅らせてからCMS初期化を試行
      setTimeout(tryInitializeCMS, 100);
    });

    // ウィンドウが完全に読み込まれた後にも実行
    window.addEventListener('load', function() {
      console.log('Window loaded');
      // 既に初期化されていない場合のみ再試行
      if (initAttempts === 0) {
        setTimeout(tryInitializeCMS, 100);
      }
    });
  </script>
</body>
</html>
