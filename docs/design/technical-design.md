# 技術設計書

## 概要

Auto Chat Makerシステムの技術設計を定義します。ローカルでの試行を前提とし、Teamsチャット対応を基本として、将来的なOutlookメール対応も考慮した拡張性のある技術構成を採用します。

## 技術構成（ローカル試行版）

### フロントエンド
| 技術 | 詳細 | 役割 |
|------|------|------|
| **UIフレームワーク** | FastAPI + HTML/JavaScript | 返信案選択・編集UI |
| **状態管理** | サーバーサイドセッション | アプリケーション状態管理 |
| **UIライブラリ** | 軽量なCSSフレームワーク | モダンなUIコンポーネント |

### バックエンド
| 技術 | 詳細 | 役割 |
|------|------|------|
| **言語** | Python 3.8以上 | メイン開発言語 |
| **Webフレームワーク** | FastAPI | RESTful API提供・Web UI |
| **ORM** | SQLAlchemy | データベース操作 |
| **非同期処理** | FastAPI非同期機能 | バックグラウンド処理 |

### MCP通信
| 技術 | 詳細 | 役割 |
|------|------|------|
| **MCPサーバー** | `ms-365-mcp-server` | Teamsチャット連携 |
| **通信プロトコル** | HTTP/HTTPS | MCPサーバーとの通信 |
| **認証** | OAuth2 | Microsoft 365認証 |

### 外部API連携
| 技術 | 詳細 | 役割 |
|------|------|------|
| **Microsoft Graph API** | Microsoft Graph API | Teamsチャット・スレッド・サブスクリプション管理 |
| **AIサービス** | Claude API（Anthropic） | 返信判断・案生成 |

### データベース
| 技術 | 詳細 | 役割 |
|------|------|------|
| **RDBMS** | SQLite | ローカルファイルベースデータベース |
| **キャッシュ** | functools.lru_cache | メモリキャッシュ |
| **マイグレーション** | Alembic | データベーススキーマ管理 |

### 開発・運用ツール
| 技術 | 詳細 | 役割 |
|------|------|------|
| **コード品質** | Black, isort, flake8, mypy | コードフォーマット・静的解析 |
| **テスト** | pytest | ユニット・統合テスト |
| **ログ出力** | structlog | 構造化ログ |

## 技術スタックの選択理由

### バックエンド技術の簡素化

#### FastAPIの採用理由
- **軽量で高速**: ローカル試行に適した軽量なフレームワーク
- **非同期対応**: 組み込みの非同期機能でCelery + Redisが不要
- **自動ドキュメント**: OpenAPI/Swaggerによる自動API文書生成
- **型安全性**: Pydanticによる強力な型チェック

#### SQLiteの採用理由
- **ファイルベース**: サーバー設定不要でローカル試行に最適
- **軽量**: メモリ使用量が少なく、起動が高速
- **単一ファイル**: バックアップ・移行が容易
- **標準ライブラリ**: 追加インストール不要

#### 非同期処理の簡素化
- **FastAPI非同期機能**: 組み込みの非同期処理でCelery + Redisが不要
- **メモリキャッシュ**: `functools.lru_cache`でRedisが不要
- **シンプルな構成**: 依存関係を最小限に抑制

### フロントエンド技術の簡素化

#### FastAPI + HTML/JavaScriptの採用理由
- **統合環境**: バックエンドとフロントエンドを同一プロジェクトで管理
- **軽量**: React/Vue.jsのような重いフレームワークが不要
- **学習コスト**: 複雑な状態管理ライブラリが不要
- **開発効率**: テンプレート機能による高速開発

## 拡張性設計

### プラグインアーキテクチャ

#### メッセージ処理プラグイン
- **共通インターフェース**: メッセージ処理の抽象化
- **Teamsチャットプラグイン**: 現在対応
- **Outlookメールプラグイン**: 将来対応予定
- **プラグイン管理**: 動的なプラグイン登録・管理

#### 設定管理
- **機能フラグ**: 各機能の有効/無効切り替え
- **プラグイン設定**: プラグイン固有の設定管理
- **ローカル設定**: 環境変数による設定管理

### データベース設計の拡張性

#### メッセージタイプ対応
- **共通テーブル**: メッセージの基本情報
- **プラグイン固有テーブル**: 各プラグインの拡張情報
- **メッセージタイプ管理**: 動的なメッセージタイプ追加

#### スキーマ設計
```sql
-- メッセージタイプ管理テーブル
CREATE TABLE message_types (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    type_name VARCHAR(50) UNIQUE NOT NULL,
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 共通メッセージテーブル
CREATE TABLE messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    message_id VARCHAR(255) UNIQUE NOT NULL,
    message_type_id INTEGER,
    content TEXT,
    sender VARCHAR(255),
    sent_at TIMESTAMP,
    processed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## パフォーマンス要件（ローカル試行版）

### 処理時間
- **チャットメッセージ処理**: 10秒以内
- **AI判定・生成**: 30秒以内
- **返信送信**: 5秒以内
- **UI応答**: 3秒以内

### スループット
- **同時ユーザー数**: 1人（ローカル試行）
- **1日あたりの処理件数**: 100件程度
- **データベース接続数**: 1接続

### 可用性
- **システム稼働率**: ローカル環境での安定動作
- **障害復旧時間**: 手動再起動による即座復旧
- **メンテナンス時間**: 必要に応じて手動停止

## 監視・ログ

### ログ出力
- **アプリケーションログ**: structlogによる構造化ログ
- **アクセスログ**: FastAPI標準のアクセスログ
- **エラーログ**: エラー詳細とスタックトレース

### メトリクス
- **API応答時間**: 各エンドポイントの応答時間
- **エラー率**: エラー発生率の監視
- **処理件数**: 1日あたりの処理件数
- **外部API呼び出し**: 外部サービスへの呼び出し回数

## 将来拡張時の考慮事項

### 本番環境移行時の技術スタック変更
- **データベース**: SQLite → PostgreSQL
- **キャッシュ**: メモリキャッシュ → Redis
- **非同期処理**: FastAPI非同期 → Celery + Redis
- **フロントエンド**: FastAPI + HTML → React/Vue.js

### スケーラビリティ対応
- **負荷分散**: 複数インスタンスでの動作
- **データベース**: 読み取り専用レプリカの追加
- **キャッシュ**: 分散キャッシュの導入

## 更新履歴

- 初版作成: 2024年12月
- Teams対応化: 2024年12月 - Teamsチャットベースに変更、拡張性設計を追加
- ローカル試行版対応: 2024年12月 - 技術スタックをローカル試行に最適化
- 設計書ディレクトリ移動: 2024年12月 - 技術設計書として適切な場所に配置
- 最終更新: 2024年12月
- 更新者: 開発チーム
