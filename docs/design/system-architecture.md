# システム全体構造設計書

## 概要

Auto Chat Makerシステムの全体構造とコンポーネント間の関係性を定義します。クリーンアーキテクチャに基づくシステム構成と、各コンポーネントの役割・関係性を明確にします。

## システム全体構成図

### システム境界とコンポーネント配置
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Auto Chat Maker システム                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐         │
│  │     Web UI      │    │     API層       │    │   外部連携層     │         │
│  │   (FastAPI)     │◄──►│   (FastAPI)     │◄──►│  (MCP/Graph)    │         │
│  │                 │    │                 │    │                 │         │
│  │ • 返信案表示    │    │ • Webhook受信   │    │ • MCPサーバー   │         │
│  │ • 設定管理      │    │ • RESTful API   │    │ • Graph API     │         │
│  │ • 履歴表示      │    │ • 認証・認可    │    │ • Claude API    │         │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘         │
│           │                       │                       │                 │
│           ▼                       ▼                       ▼                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐         │
│  │   設定管理層    │    │ アプリケーション層 │    │   AIサービス    │         │
│  │   (Config)      │    │ (Use Cases)     │    │  (Claude)       │         │
│  │                 │    │                 │    │                 │         │
│  │ • 環境変数管理  │    │ • メッセージ処理 │    │ • 返信要否判定  │         │
│  │ • 設定バリデーション│ │ • 返信案生成    │    │ • 返信案生成    │         │
│  │ • 機能フラグ    │    │ • 返信送信      │    │ • 品質管理      │         │
│  └─────────────────┘    │ • プラグイン管理│    └─────────────────┘         │
│           │             └─────────────────┘                       │         │
│           ▼                       │                               │         │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐         │
│  │   ドメイン層    │    │  インフラ層     │    │   データ層      │         │
│  │  (Entities)     │◄──►│ (Adapters)      │◄──►│ (Database)      │         │
│  │                 │    │                 │    │                 │         │
│  │ • チャットメッセージ│ │ • DBリポジトリ  │    │ • SQLite DB     │         │
│  │ • 返信案エンティティ│ │ • 外部APIクライアント│ │ • データマイグレーション│         │
│  │ • ユーザーエンティティ│ │ • プラグイン実装│    │ • キャッシュ    │         │
│  │ • リポジトリIF  │    │ • ログ出力      │    │                 │         │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## コンポーネント詳細

### 1. Web UI層
**責任**: ユーザーインターフェースの提供

**コンポーネント**:
- **返信案表示UI**: 生成された返信案の表示・選択
- **設定管理UI**: システム設定の変更・確認
- **履歴表示UI**: 処理済みメッセージの履歴表示

**主要機能**:
- 返信案の一覧表示
- 返信案の選択・編集
- 送信実行
- 設定変更
- 履歴確認

### 2. API層
**責任**: HTTPリクエストの受信・処理・レスポンス

**コンポーネント**:
- **Webhook受信**: Microsoft Graph Webhookの受信
- **RESTful API**: チャットメッセージ管理API
- **認証・認可**: OAuth2認証・JWT認可
- **バリデーション**: リクエスト・レスポンスの検証

**主要エンドポイント**:
- `POST /api/webhook/microsoft-graph` - Webhook受信
- `GET /api/chat-messages` - メッセージ一覧取得
- `POST /api/chat-messages/{id}/reply` - 返信送信

### 3. 外部連携層
**責任**: 外部システムとの連携

**コンポーネント**:
- **MCPサーバー連携**: Teamsチャット操作
- **Microsoft Graph API**: Webhook管理・メタデータ取得
- **Claude API**: AI判定・生成

**主要機能**:
- Teamsチャットメッセージ取得
- Teamsチャット返信送信
- Webhookサブスクリプション管理
- AI判定・生成

### 4. アプリケーション層
**責任**: ビジネスプロセスの調整

**コンポーネント**:
- **メッセージ処理ユースケース**: チャットメッセージの処理フロー
- **返信案生成ユースケース**: AIによる返信案生成
- **返信送信ユースケース**: 選択された返信の送信
- **プラグイン管理**: メッセージ処理プラグインの管理

**主要フロー**:
1. Webhook受信 → メッセージ処理
2. AI判定 → 返信案生成
3. ユーザー選択 → 返信送信

### 5. ドメイン層
**責任**: ビジネスルールとエンティティ

**コンポーネント**:
- **チャットメッセージエンティティ**: メッセージの基本情報
- **返信案エンティティ**: AI生成返信案
- **ユーザーエンティティ**: ユーザー情報
- **リポジトリインターフェース**: データアクセスの抽象化

**主要エンティティ**:
- `ChatMessage`: メッセージID、内容、送信者、送信日時
- `ReplySuggestion`: 返信案ID、内容、信頼度、選択状態
- `User`: ユーザーID、メール、名前

### 6. インフラストラクチャ層
**責任**: 外部システムとの連携実装

**コンポーネント**:
- **データベースリポジトリ**: SQLAlchemy実装
- **外部APIクライアント**: HTTP通信実装
- **プラグイン実装**: Teamsチャット処理プラグイン
- **ログ出力**: structlog実装

**主要実装**:
- SQLAlchemy ORM
- httpx HTTPクライアント
- Teamsチャットプラグイン
- 構造化ログ出力

### 7. データ層
**責任**: データの永続化

**コンポーネント**:
- **SQLiteデータベース**: ローカルファイルベースDB
- **データマイグレーション**: Alembic
- **キャッシュ**: メモリキャッシュ

**主要テーブル**:
- `users`: ユーザー情報
- `chat_messages`: チャットメッセージ
- `reply_suggestions`: 返信案
- `subscriptions`: Webhookサブスクリプション

### 8. 設定管理層
**責任**: アプリケーション設定の管理

**コンポーネント**:
- **環境変数管理**: .envファイル読み込み
- **設定バリデーション**: Pydantic Settings
- **機能フラグ**: 機能の有効/無効制御

**主要設定**:
- データベース接続情報
- 外部API認証情報
- 機能フラグ設定
- ログレベル設定

## コンポーネント間の関係性

### 依存関係の方向
```
Web UI → API → アプリケーション → ドメイン ← インフラストラクチャ → データ
   ↓        ↓           ↓           ↓              ↓
設定管理 ←─────────────────────────────────────────────────────
```

### データフロー詳細

#### 1. Webhook受信フロー
```
Microsoft Graph → API層(Webhook受信) → アプリケーション層(メッセージ処理)
    → ドメイン層(エンティティ作成) → インフラ層(DB保存) → データ層(SQLite)
```

#### 2. 返信案生成フロー
```
ドメイン層(メッセージ取得) → アプリケーション層(返信案生成)
    → 外部連携層(Claude API) → アプリケーション層(結果処理)
    → ドメイン層(返信案エンティティ) → インフラ層(DB保存) → データ層(SQLite)
```

#### 3. 返信送信フロー
```
Web UI(返信選択) → API層(返信送信) → アプリケーション層(送信処理)
    → 外部連携層(MCPサーバー) → Teams(メッセージ送信)
```

## プラグインアーキテクチャ

### プラグイン構造
```
┌─────────────────────────────────────┐
│           プラグイン管理             │
├─────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐   │
│  │Teamsチャット│  │Outlookメール│   │
│  │  プラグイン  │  │  プラグイン  │   │
│  │ (現在対応)   │  │ (将来対応)   │   │
│  └─────────────┘  └─────────────┘   │
└─────────────────────────────────────┘
```

### プラグインインターフェース
```python
class MessageProcessor(ABC):
    @abstractmethod
    def process_message(self, message: Dict[str, Any]) -> Dict[str, Any]:
        """メッセージを処理する"""
        pass

    @abstractmethod
    def send_reply(self, message_id: str, content: str) -> bool:
        """返信を送信する"""
        pass

    @abstractmethod
    def get_message_type(self) -> str:
        """メッセージタイプを取得する"""
        pass
```

## セキュリティアーキテクチャ

### 認証・認可フロー
```
ユーザー → OAuth2認証 → JWTトークン生成 → API認可 → リソースアクセス
```

### データ保護
- **通信暗号化**: TLS 1.3
- **データベース暗号化**: SQLite暗号化拡張
- **機密情報**: 環境変数による管理
- **アクセス制御**: ロールベースアクセス制御

## パフォーマンス設計

### 非同期処理
- **FastAPI非同期**: 同時リクエスト処理
- **データベース接続**: 接続プール
- **キャッシュ**: メモリキャッシュ

### スケーラビリティ
- **水平スケーリング**: 複数インスタンス対応
- **垂直スケーリング**: リソース増強対応
- **データベース**: 読み取り専用レプリカ対応

## 監視・ログ設計

### ログ構造
```
アプリケーション層 → structlog → 構造化ログ → ファイル出力
```

### メトリクス
- **API応答時間**: 各エンドポイントの性能
- **エラー率**: システム安定性
- **処理件数**: システム稼働状況
- **外部API呼び出し**: 外部サービス依存度

## 更新履歴

- 初版作成: 2024年12月
- システム全体構造設計: 2024年12月 - コンポーネント間関係性を明確化
- 最終更新: 2024年12月
- 更新者: 開発チーム
